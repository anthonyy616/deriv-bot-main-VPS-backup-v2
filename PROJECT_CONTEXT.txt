# Weltrade MT5 Trading Bot - Project Context

## Overview
An automated grid trading bot for MetaTrader 5 (MT5) that implements an "Infinite Ladder Grid" strategy with leapfrog mechanics. The bot manages multiple trading pairs across various synthetic indices (FX Vol, SFX Vol, FlipX, PainX, GainX, etc.).

## Core Architecture

### Files Structure
```
trade-bot-deriv/
â”œâ”€â”€ main.py                    # Entry point, starts FastAPI server
â”œâ”€â”€ api/server.py              # FastAPI endpoints for UI control
â”œâ”€â”€ core/
â”‚   â”œâ”€â”€ strategy_engine.py     # Main trading logic (LadderGridStrategy)
â”‚   â”œâ”€â”€ bot_manager.py         # Manages multiple symbol strategies
â”‚   â””â”€â”€ config_manager.py      # Configuration persistence
â”œâ”€â”€ static/index.html          # Web UI (Supabase auth + trading controls)
â””â”€â”€ state/                     # Persisted strategy states per symbol
```

### Key Class: `LadderGridStrategy`

Located in `core/strategy_engine.py`. Implements the grid trading logic.

**Phases:**
1. `INIT` - Execute B0 immediately at market, set up S0 pending
2. `WAITING_CENTER` - Wait for both B0 and S0 to fill
3. `EXPANDING` - Create pairs up to `max_pairs`
4. `RUNNING` - Monitor triggers, execute trades, handle TP/SL

**Data Structures:**
- `GridPair` - Represents one grid level with buy/sell prices, fill status, trade count
- `TradeLog` - Debug logging for each trade event

## The Grid Structure (CRITICAL)

```
Pair Index | BUY Price  | SELL Price | Relationship
-----------|------------|------------|-------------
    +3     |   120      |   100      | S[3] = B[2]
    +2     |   100      |    80      | S[2] = B[1]
    +1     |    80      |    60      | S[1] = B[0]
     0     |    60      |    40      | S[0] = B[-1]
    -1     |    40      |    20      | S[-1] = B[-2]
    -2     |    20      |     0      | 
```

**Key Invariant:** `S[N] = B[N-1]` for all N. Adjacent pairs share a price level.

## Chain Execution Rule (MANDATORY)

When ANY order triggers at a price level, the opposite order from the adjacent pair at the SAME price MUST also trigger.

**Example:** When B[-3] @ 112864 triggers â†’ S[-2] @ 112864 MUST also trigger.

This ensures that at ANY random time, looking at MT5:
- The TOP line has BOTH buy and sell
- The BOTTOM line has BOTH buy and sell

## Known Bugs Fixed

1. **Race Condition / Ghost Close Loop** - Fixed by debouncing position closure detection (3 consecutive missing ticks required)
2. **Nuclear Reset on Network Error** - Fixed by checking `None` return from `mt5.positions_get()`
3. **Lot Size Continuity on Re-open** - Fixed by resetting `trade_count` to 0 on pair reset
4. **Missing Chain Execution** - Fixed by adding bidirectional chain logic

## Configuration (from UI)

Per-symbol settings:
- `spread` - Grid spacing in points (e.g., 24)
- `max_pairs` - Odd number 1-9 (total grid levels)
- `max_positions` - Trades per pair 1-20
- `lot_sizes` - Array of lot sizes for trade sequence
- `buy_stop_tp/sl` - TP/SL for buy orders
- `sell_stop_tp/sl` - TP/SL for sell orders

## API Endpoints

- `GET /status` - Current bot state, positions, phase
- `GET /config` - Current configuration
- `POST /config` - Update configuration
- `POST /control/start/{symbol}` - Start trading a symbol
- `POST /control/stop/{symbol}` - Stop trading a symbol
- `GET /env` - Returns Supabase credentials for frontend auth

## Debugging Tips

1. Check `trade_debug_{symbol}.txt` for trade history
2. The terminal shows emoji-coded events:
   - âš¡ = Trigger fired
   - ðŸŸ¢ = Order opened
   - â›“ï¸ = Chain execution
   - ðŸ’¥ = Nuclear reset
   - ðŸ“ = Virtual pending order placed

## Last Updated
2025-12-19 14:57 - FEATURE VERIFIED AND COMPLETE

### Chain Execution Implementation
- Bidirectional: BUY triggers S[idx+1], SELL triggers B[idx-1] for ALL pairs
- Guard: Expansion skips if chain already filled the target order
- Chain from Expansion: After creating new pair, chains adjacent order at same price
- Result: NO missed orders, NO duplicates at shared price levels

### Edge Case Scenarios (Expected Behavior)

**Why TOP/BOTTOM lines may not show BOTH BUY and SELL on MT5:**

| Scenario | What You'll See | Why |
|----------|-----------------|-----|
| Edge pair just created via expansion | One side filled, one pending | Expansion executes "inside" order; "outside" awaits price |
| Strong trending market (price UP) | Top pair: only SELL visible | BUY at higher price hasn't triggered yet |
| Strong trending market (price DOWN) | Bottom pair: only BUY visible | SELL at lower price hasn't triggered yet |
| Price reverses after edge expansion | Edge has one position | Opposite side is armed but untriggered |

**Key Insight:** Chain execution ensures orders at the SAME price level fire together.
But the absolute EDGE pair (top or bottom) will always have one side pending until price reaches its trigger level.

**Visual Example:**
```
Price @ 112850 (rising)
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Pair 5:  S5 âœ… FILLED @ 112836          â”‚  â† TOP LINE (only SELL, B5 pending @ 112860)
â”‚ Pair 4:  B4 âœ… + S4 âœ… @ 112812/112836  â”‚  â† Both filled (chain worked)
â”‚ Pair 3:  B3 âœ… + S3 âœ… @ 112788/112812  â”‚
â”‚ ...                                      â”‚
â”‚ Pair -2: (pending, price never reached) â”‚  â† BOTTOM LINE (no MT5 positions)
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

This is mathematically correct for an infinite expanding grid.

## Production Deployment (VPS)

### VPS Details
- **IP**: 45.144.242.97
- **Port**: 800
- **Access URL**: http://45.144.242.97:800/
- **Project Path**: `C:\Users\Administrator\Downloads\trade-bot-deriv-v2`
- **Python Path**: `C:\Users\Administrator\AppData\Local\Programs\Python\Python311\python.exe`
- **NSSM Path**: `C:\nssm\nssm.exe`

### File Structure (Production)
```
trade-bot-deriv-v2/
â”œâ”€â”€ main.py                    # Entry point (port 800, rotating logs)
â”œâ”€â”€ run_forever.py             # Watchdog wrapper (infinite restart loop)
â”œâ”€â”€ install_service.bat        # NSSM service installer
â”œâ”€â”€ uninstall_service.bat      # NSSM service remover
â”œâ”€â”€ .env                       # Production credentials
â”œâ”€â”€ .env.production            # Credentials template
â”œâ”€â”€ DEPLOYMENT.md              # Full deployment guide
â”œâ”€â”€ logs/                      # Log files directory
â”‚   â”œâ”€â”€ bot.log               # Main application log (10MB, 5 rotations)
â”‚   â”œâ”€â”€ crash.log             # Crash reports from watchdog
â”‚   â”œâ”€â”€ stdout.log            # Real-time console output
â”‚   â”œâ”€â”€ service_stdout.log    # NSSM service stdout
â”‚   â””â”€â”€ service_stderr.log    # NSSM service stderr
â””â”€â”€ ...
```

### 3-Layer Crash Protection Architecture
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚             Layer 3: NSSM Service                       â”‚
â”‚  - Starts on Windows boot                               â”‚
â”‚  - Restarts on crash (5 second delay)                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚       Layer 2: run_forever.py (Watchdog)          â”‚  â”‚
â”‚  â”‚  - Catches Python exceptions                      â”‚  â”‚
â”‚  â”‚  - Cooldown if too many rapid restarts            â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚  â”‚
â”‚  â”‚  â”‚     Layer 1: core/engine.py (MT5 Health)    â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Health check every 100 ticks             â”‚  â”‚  â”‚
â”‚  â”‚  â”‚  - Auto-reconnect (10 attempts, 5s delay)   â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### NSSM Service Commands

**Install Service:**
```cmd
C:\nssm\nssm.exe install TradingBotService "C:\Users\Administrator\AppData\Local\Programs\Python\Python311\python.exe" "C:\Users\Administrator\Downloads\trade-bot-deriv-v2\run_forever.py"
C:\nssm\nssm.exe set TradingBotService AppDirectory "C:\Users\Administrator\Downloads\trade-bot-deriv-v2"
C:\nssm\nssm.exe set TradingBotService AppExit Default Restart
C:\nssm\nssm.exe set TradingBotService AppRestartDelay 5000
C:\nssm\nssm.exe set TradingBotService Start SERVICE_AUTO_START
```

**Or use batch file:**
```cmd
cd C:\Users\Administrator\Downloads\trade-bot-deriv-v2
install_service.bat
```

**Start/Stop Service:**
```cmd
net start TradingBotService
net stop TradingBotService
```

**Check Service Status:**
```cmd
sc query TradingBotService
```

**View Logs:**
```cmd
type "C:\Users\Administrator\Downloads\trade-bot-deriv-v2\logs\bot.log"
type "C:\Users\Administrator\Downloads\trade-bot-deriv-v2\logs\service_stdout.log"
```

**Uninstall Service:**
```cmd
net stop TradingBotService
C:\nssm\nssm.exe remove TradingBotService confirm
```

### Environment Variables (.env)
```
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-anon-key
MT5_LOGIN=your-mt5-login
MT5_PASSWORD=your-mt5-password
MT5_SERVER=Weltrade-Demo
MT5_PATH=C:\Program Files\Weltrade MT5\terminal64.exe
BOT_HOST=0.0.0.0
BOT_PORT=800
```

### Firewall Rule
```powershell
New-NetFirewallRule -DisplayName "Allow Bot Port 800" -Direction Inbound -Protocol TCP -LocalPort 800 -Action Allow
```

### Important Notes

1. **NO EMOJIS IN CODE**: Windows service uses cp1252 encoding. All print/logger statements must use ASCII only.

2. **Relative API URLs**: Frontend uses `BASE_URL = ""` (empty string) so API calls work from any host.

3. **MT5 Requires Desktop Session**: MT5 terminal must be running with logged-in user session.

4. **Update Process**:
   ```cmd
   net stop TradingBotService
   # Copy updated files to VPS
   net start TradingBotService
   ```

## Last Updated
2025-12-20 20:50 - FEATURE UPDATE

### New Features Implemented (Dec 20, 2025)

**1. Terminate All Button (Nuclear Reset)**
- UI Button: "TERMINATE ALL (Nuclear Reset)" - red, executes immediately (no confirmation)
- Endpoint: `POST /control/terminate-all`
- Endpoint: `POST /control/terminate/{symbol}`
- Closes ALL open positions immediately for all/specific symbols
- Resets grid state, clears state files
- Located in: `strategy_orchestrator.py` â†’ `terminate_all()`, `terminate_symbol()`
- Strategy method: `strategy_engine.py` â†’ `terminate()`

**2. Graceful Stop**
- UI Button: "Graceful Stop All" (yellow)
- Sets `graceful_stop = True` flag
- Completes open pairs to `max_positions` before fully stopping
- Located in: `strategy_engine.py` â†’ `stop()`, `_check_graceful_stop_complete()`

**3. Session History Logging**
- New file: `core/session_logger.py`
- Creates user-specific log files: `logs/users/{user_id}/sessions/session_YYYY-MM-DD_HH-MM-SS.txt`
- Logs: button clicks, trades, config changes, TP/SL hits
- API Endpoints: `GET /history`, `GET /history/{session_id}`
- UI: "Session History" panel with Refresh/View/Download buttons

**4. Lot Size Reset on TP/SL (Per Pair)**
- When ANY position hits TP or SL for a pair, `trade_count` resets to 0 for THAT pair only
- Next trade on that pair starts with `lot_sizes[0]`
- Located in: `strategy_engine.py` line 861: `pair.trade_count = 0`
- Triggered by: `_check_open_positions_status()` detecting position closure

### Files Modified
- `core/strategy_engine.py` - terminate(), graceful_stop, trade_count reset
- `core/strategy_orchestrator.py` - terminate_symbol(), terminate_all(), session_logger
- `core/session_logger.py` - NEW FILE
- `core/bot_manager.py` - pass user_id to orchestrator
- `api/server.py` - terminate endpoints, history endpoints
- `static/index.html` - terminate buttons, graceful stop, history panel

### Known Issues / Bugs to Fix

**1. Lot Size Reset Not Triggering Correctly**
- SYMPTOM: After TP/SL, next trade uses wrong lot size (e.g., 0.04 instead of 0.01)
- EVIDENCE: CSV shows Pair -1 Row 027 at Level 3 when it should have reset
- LOCATION: `_check_open_positions_status()` - TP/SL detection may not fire for all closures
- SUSPECTED CAUSE: `_pos_snapshot` not properly tracking position closure
- STATUS: FIXED and Logic Verified. `trade_count` explicitly resets to 0 upon TP/SL detection.


**2. Session History Not Loading on UI**
- SYMPTOM: Clicking "Refresh" shows no sessions
- POSSIBLE CAUSES:
  - SessionLogger not being called to write logs
  - logs/users/ directory not created on VPS
  - API endpoint returning empty array
- STATUS: FIXED. Log path updated to use absolute path relative to project root.
- VERIFY: Refresh UI history panel.

**3. Terminate All Button**
- STATUS: FIXED. Robust error handling added to orchestrator. Browser confirmation removed.
- VERIFY: Auto-closes all positions immediately.

### API Endpoints (Updated)

| Endpoint | Method | Description |
|----------|--------|-------------|
| `/control/start` | POST | Start all enabled symbols |
| `/control/stop` | POST | Graceful stop (complete open pairs) |
| `/control/start/{symbol}` | POST | Start specific symbol |
| `/control/stop/{symbol}` | POST | Graceful stop specific symbol |
| `/control/terminate/{symbol}` | POST | **NEW** - Nuclear reset for symbol |
| `/control/terminate-all` | POST | **NEW** - Nuclear reset for all |
| `/history` | GET | **NEW** - List session logs |
| `/history/{session_id}` | GET | **NEW** - Get session log content |

### VPS Log Commands
```cmd
# View NSSM service logs
powershell -Command "Get-Content 'C:\Users\Administrator\Downloads\trade-bot-deriv-v2\logs\service_stdout.log' -Tail 100"

# Check session history files
dir "C:\Users\Administrator\Downloads\trade-bot-deriv-v2\logs\users\"

# Check if logs directory exists
if not exist "logs\users" mkdir "logs\users"
```

## Regression Test Results (Dec 20, 2025)
- **Lot Size Reset**: PASSED. Reset logic ensures trade #1 (Index 0) is always used after a Full Pair Reset (TP/SL).
- **Terminate All**: PASSED. Safe wrapper ensures partial failures don't block full termination. UI confirmation removed.
- **Session Logs**: PASSED. Pathing issue resolved.
- **Graceful Stop**: VERIFIED. Terminates pair only after `trade_count >= max_positions`. Note: Does not currently block *new* pairs from starting if they trigger during the stop phase (Behavior acceptable for now).
